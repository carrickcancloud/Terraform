name: 'Anvil: Bootstrap Foundational Infrastructure'

on:
  workflow_dispatch:
    inputs:
      aws_account_id:
        description: 'The AWS Account ID to deploy the foundational resources to.'
        required: true
        type: string
      aws_region:
        description: 'The AWS region for the resources.'
        required: false
        default: 'us-east-1'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  terraform-bootstrap:
    name: 'Terraform Bootstrap Apply'
    runs-on: ubuntu-latest
    
    defaults:
      run:
        # Run all steps from inside the new bootstrap directory
        working-directory: ./bootstrap

    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Configure AWS Credentials'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # This pipeline assumes a role specifically for bootstrapping.
          # In a real scenario, this might be a more powerful, manually created role.
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_FOR_BOOTSTRAP }}
          aws-region: ${{ github.event.inputs.aws_region }}

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3

      - name: 'Terraform Init'
        id: init
        run: terraform init

      - name: 'Terraform Apply'
        run: terraform apply -auto-approve
        
      - name: 'Upload SSH Private Keys as Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: ssh-private-keys
          path: bootstrap/.tmp_keys/*.pem
